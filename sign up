# ---------------------------------------------
# SIGN UP / REGISTER
# ---------------------------------------------
@app.route('/register', methods=['GET', 'POST'])
def register():
    """
    Handles account registration for Riget Zoo Adventures.
    - GET: show the sign up form
    - POST: validate input and create a new user
    """

    # If the form was submitted
    if request.method == 'POST':
        # 1. Get form data
        first_name = request.form.get('first_name', '').strip()
        last_name = request.form.get('last_name', '').strip()
        email = request.form.get('email', '').strip().lower()
        password = request.form.get('password', '')
        confirm_password = request.form.get('confirm_password', '')

        # 2. Validation
        error = None

        if not first_name or not last_name or not email or not password or not confirm_password:
            error = "All fields are required."
        elif "@" not in email:
            error = "Please enter a valid email address."
        elif len(password) < 8:
            error = "Password must be at least 8 characters long."
        elif password != confirm_password:
            error = "Passwords do not match."
        else:
            # 3. Check if email already exists in database
            existing_user = User.query.filter_by(email=email).first()
            if existing_user:
                error = "An account with that email already exists."

        # 4. If there is an error → re-render template with error message
        if error:
            # This will populate {{ error }} in your signup template
            return render_template("signup.html", error=error)

        # 5. If no errors → hash password and create user
        hashed_pw = bcrypt.generate_password_hash(password).decode("utf-8")

        new_user = User(
            first_name=first_name,
            last_name=last_name,
            email=email,
            password=hashed_pw,
            role="visitor"  # or "user" depending on how you named it
        )

        # Save to DB
        db.session.add(new_user)
        db.session.commit()

        # Feedback + redirect to login page
        flash("Account created successfully. You can now log in.", "success")
        return redirect(url_for('login'))

    # If GET request → show the empty form
    return render_template("signup.html", error=None)
